# micro:bit Music Player 開発者向けドキュメント

micro:bit単体で動作する多機能音楽プレーヤー。

## プロジェクト概要

### 開発動機

- micro:bitの音楽機能を最大限活用
- ゲーム音楽（RPG序曲など）を手軽に演奏
- ハードウェア制約の中で豊かな音楽体験を提供
- 教育現場で音楽とプログラミングの融合を示す

## プロジェクト構造

```
microbit-music/
└── main.py           # メインプログラム（約115行）
```

## アーキテクチャ

```
┌─────────────────────────────────────┐
│         Main Loop (while True)      │
│  ┌───────────────────────────────┐  │
│  │  1. ボタン入力チェック         │  │
│  │  2. 曲データ取得              │  │
│  │  3. 音階変換                  │  │
│  │  4. LED表示                   │  │
│  │  5. 音声再生                  │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

## データ構造

### 曲データベース

```python
songs = {
    "曲名1": [音階データ...],
    "曲名2": [音階データ...],
}
```

### 音階データフォーマット

```python
'音名+オクターブ:長さ'
例: 'C5:4' → C5の音を4単位の長さで

音名: C, C#, D, D#, E, F, F#, G, G#, A, A#, B
オクターブ: 3～8
長さ: 1～8（数値が大きいほど長い）
```

### グローバル状態

```python
song_names = list(songs.keys())     # 曲名リスト
current_song_index = 0              # 現在の曲番号
shift = 0                           # キーシフト量（半音単位）
notes = ['C', 'C#', 'D', ...]       # 音階テーブル（12平均律）
```

## 主要関数

### shift_note(note, shift)

音階をシフトする関数。

**処理フロー**:
1. 音名とオクターブを分離（'C#5' → pitch='C#', octave=5）
2. 音階テーブルでインデックス検索
3. シフト適用
4. オクターブ調整（境界処理）
5. 新しい音階文字列を生成

**計算量**: O(1)

### display_pitch(note)

音の高さをLEDバーで可視化。

- 12音階を5列×3段階にマッピング
- col = idx // 3（列：0-4）
- level = (idx % 3) + 1（高さ：1-3）

### next_song() / prev_song()

曲切り替え関数。

- インデックスを更新（循環）
- キーを自動リセット
- 曲名をスクロール表示

## ボタン入力処理

### 入力判定フロー

```
ボタン押下検出 → 800ms待機 → 長押し/短押し判定
```

### 入力マトリクス

| ボタン | 短押し | 長押し |
|--------|--------|--------|
| A | キー-1 | 前の曲 |
| B | キー+1 | 次の曲 |
| A+B | キーリセット | キーリセット |

## 12平均律の実装

```python
notes = ['C', 'C#', 'D', 'D#', 'E', 'F',
         'F#', 'G', 'G#', 'A', 'A#', 'B']
```

- 12音を1オクターブとして定義
- 半音（semitone）が基本単位
- 循環構造（12でモジュロ演算）

**境界処理**:
```python
if idx < 0:
    octave -= 1
    idx += 12
if idx >= 12:
    octave += 1
    idx -= 12
```

## パフォーマンス

### メモリ使用量

```
songs辞書: 約200-300バイト（2曲）
グローバル変数: 約100バイト
関数コード: 約500バイト
合計: 約1KB以下
```

### CPU負荷

- 全操作: O(1)
- リアルタイム処理に十分な性能

## 依存関係

```python
from microbit import *  # display, button_a, button_b, sleep
import music           # music.play
```

## ハードウェア要件

- micro:bit v1.x または v2.x
- スピーカー（内蔵または外部）
- 電源（USB/バッテリー）

## 教育的価値

### プログラミング概念

- リスト・辞書のデータ構造
- 関数の定義と呼び出し
- グローバル変数の管理
- 条件分岐とループ

### 音楽理論

- 音階の構造（12音階）
- オクターブの概念
- 移調（キー変更）の仕組み

## 拡張計画

### Phase 2（予定）

- LED演出強化（オクターブを5段階で表現）
- 楽曲追加（ドラクエ戦闘曲、FFビクトリーファンファーレ）
- テンポ調整機能
- 再生モード切り替え（ループ/ワンショット）

### 拡張ポイント

1. **曲の追加**: `songs`辞書に追加するだけ
2. **LED演出**: `display_pitch()`関数の変更
3. **テンポ調整**: 新しいグローバル変数追加
4. **再生モード**: ループ/ワンショット切り替え

## テスト項目

- [ ] 起動時に"Ready"表示
- [ ] 曲が自動再生される
- [ ] A短押し → キー下がる
- [ ] B短押し → キー上がる
- [ ] A長押し → 前の曲
- [ ] B長押し → 次の曲
- [ ] A+B → キーリセット
- [ ] キー+12/-12（1オクターブ）
- [ ] 演奏中の操作割り込み

## 既知の制限事項

### ハードウェア制限

- 単音のみ（和音は再生不可）
- 音質: 単純な矩形波
- 入力: ボタン2つのみ
- 表示: 5×5 LEDのみ

### ソフトウェア制限

- 曲数: メモリに依存（推奨5-10曲）
- 音長: 離散的な値のみ
- テンポ: 固定（現状）

## 参考資料

- [micro:bit MicroPython ドキュメント](https://microbit-micropython.readthedocs.io/)
- [Music module リファレンス](https://microbit-micropython.readthedocs.io/en/latest/music.html)
